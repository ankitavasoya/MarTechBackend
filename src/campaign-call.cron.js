(()=>{"use strict";var e={6752:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.App=void 0;const o=a(6860),n=a(3582),i=a(7455),s=a(5086),l=a(2471),d=a(2720),r=a(3645),u=a(5566),c=a(4858),p=a(8470),m=a(930),f=a(4559),y=a(2219),_=a(5280),g=a(1058),S=a(393),T=a(8791),w=a(5937),h=a(7906);t.App=class{constructor(){const{router:e,setQueues:t,replaceQueues:a,addQueue:l,removeQueue:r}=(0,s.createBullBoard)(this.registerQueueForBullBoard());this.app=o(),this.app.use(n()),this.app.use(i()),this.app.use(o.json({limit:"10kb"})),this.app.use(o.static("//storage")),this.app.use(o.urlencoded({extended:!0})),this.app.get("/",((e,t)=>{t.send({message:"API is running"})})),this.app.use("/admin/bull-board",e),this.app.use("/api/v1/users",u.default),this.app.use("/api/v1/industries",p.default),this.app.use("/api/v1/account",y.default),this.app.use("/api/v1/account/audiences",_.default),this.app.use("/api/v1/account/campaigns",g.default),this.app.use("/api/v1/account/tags",S.default),this.app.use("/api/v1/customers",c.default),this.app.use("/api/v1/sms",m.default),this.app.use("/api/v1/logs",f.default),this.app.get("/email/unsubsribe/",h.CampaignController.unsubscribeCompany),this.app.all("*",((e,t,a)=>{a(new d.default(`can't find ${e.originalUrl}`,404))})),this.app.use(T.default)}listen(){const e=r.Config.port,t=this.app.listen(e);return t.on("error",(t=>{if("listen"!==t.syscall)throw t;const a="string"==typeof e?`Pipe ${e}`:`Port ${e}`;switch(t.code){case"EACCES":console.error(`www - ${a} requires elevated privileges`),process.exit(1);case"EADDRINUSE":console.error(`www - ${a} is already in use`),process.exit(1);default:throw t}})),t}registerQueueForBullBoard(){return Object.values(w.queues).map((e=>new l.BullMQAdapter(e)))}}},1767:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={port:process.env.REDIS_PORT||6379,host:process.env.REDIS_HOST,password:process.env.REDIS_PASSWORD}},6499:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RETRY_CONFIG=t.CAMPAIGN_PHONE_NUMBERS_EMAIL_SEND=t.CAMPAIGN_PHONE_NUMBERS_SMS_SEND=t.CAMPAIGN_PHONE_NUMBERS_CALL_SEND=t.JOB_NAMES=t.QUEUES=void 0,t.QUEUES={CAMPAIGN_CALL:"campaign_call",CAMPAIGN_SMS:"campaign_sms",CAMPAIGN_EMAIL:"campaign_email",CAMPAING_STEP_TRIGGER:"campaing_step_trigger",AUDIENCE_BATCH:"audience_batch",CUSTOMER_ADD:"customer_add"},t.JOB_NAMES={AUDIENCE:{PROCESS_AUDIENCE_ALL:"process_audience_all"},CAMPAIGN:{PROCESS_CALLS:"process_calls",PROCESS_SMS:"process_sms",PROCESS_EMAIL:"process_email",PROCESS_CAMPAING_STEP_TRIGGER:"process_campaing_step_trigger"},CUSTOMER:{ADD:"customer_add"}},t.CAMPAIGN_PHONE_NUMBERS_CALL_SEND=50,t.CAMPAIGN_PHONE_NUMBERS_SMS_SEND=50,t.CAMPAIGN_PHONE_NUMBERS_EMAIL_SEND=50,t.RETRY_CONFIG={attempts:3,backoff:{type:"exponential",delay:1e3}}},5303:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.worker=void 0;const o=a(7807),n=a(1767),i=a(6499),s=a(6244),l=new o.Queue(i.QUEUES.AUDIENCE_BATCH,{connection:n.default});t.worker=s.default,t.default=l},9190:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.scheduler=t.worker=void 0;const o=a(7807),n=a(1767),i=a(6499),s=a(6909),l=new o.QueueScheduler(i.QUEUES.CAMPAIGN_CALL,{connection:n.default}),d=new o.Queue(i.QUEUES.CAMPAIGN_CALL,{connection:n.default});t.worker=s.default,t.scheduler=l,t.default=d},3174:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.scheduler=t.worker=void 0;const o=a(7807),n=a(1767),i=a(6499),s=a(2709),l=new o.QueueScheduler(i.QUEUES.CAMPAIGN_EMAIL,{connection:n.default}),d=new o.Queue(i.QUEUES.CAMPAIGN_EMAIL,{connection:n.default});t.worker=s.default,t.scheduler=l,t.default=d},1731:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.scheduler=t.worker=void 0;const o=a(7807),n=a(1767),i=a(6499),s=a(992),l=new o.QueueScheduler(i.QUEUES.CAMPAIGN_SMS,{connection:n.default}),d=new o.Queue(i.QUEUES.CAMPAIGN_SMS,{connection:n.default});t.worker=s.default,t.scheduler=l,t.default=d},9644:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.scheduler=t.worker=void 0;const o=a(7807),n=a(1767),i=a(6499),s=a(9684),l=new o.QueueScheduler(i.QUEUES.CAMPAING_STEP_TRIGGER,{connection:n.default}),d=new o.Queue(i.QUEUES.CAMPAING_STEP_TRIGGER,{connection:n.default});t.worker=s.default,t.scheduler=l,t.default=d},8176:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.scheduler=t.worker=void 0;const o=a(7807),n=a(1767),i=a(6499),s=a(6160),l=new o.QueueScheduler(i.QUEUES.CUSTOMER_ADD,{connection:n.default}),d=new o.Queue(i.QUEUES.CUSTOMER_ADD,{connection:n.default});t.worker=s.default,t.scheduler=l,t.default=d},5937:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.queues=void 0;const o=a(5303),n=a(9190),i=a(1731),s=a(9644),l=a(8176);t.queues={audienceBatchQueue:o.default,campaignCallQueue:n.default,campaignStepProcessQueue:s.default,campaignSmsQueue:i.default,customerAdd:l.default}},6244:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(7807),i=a(5828),s=a(6499),l=a(7651),d=a(6584),r=a(6645),u=a(3553),c=a(6517),p=a(1767),m=new n.Worker(s.QUEUES.AUDIENCE_BATCH,(e=>o(void 0,void 0,void 0,(function*(){let t,a=e.data.filters,n=e.data.companyId;const s=e.data.audience;r.default.info(`Will add customers in audience ${s.id}`);const p=(e=0,u=0)=>o(void 0,void 0,void 0,(function*(){if(e>=t)return t;const[o,m]=yield l.CustomerController.getCustomersData({page:u,count:1e3,filters:a,attributes:["id","is_deleted"],companyId:n});t||(r.default.info(`Processing total ${m} customers for audience ${s.id}`),t=m);const f=c.map(o,(e=>({id:(0,i.v4)(),audience_id:s.id,customer_id:e.id})));return yield d.Models.AudienceCustomer.bulkCreate(f),r.default.info(`Added ${f.length} customers for audience ${s.id} page ${u} count 1000`),p(e+=1e3,u+=1)}));return yield p(),r.default.info(`Successfully sent ${t} customers for audience ${s.id}`),yield d.Models.Audience.update({creation_status:u.AUDIENCE_CREATION_STATUS.CREATED},{where:{id:s.id}}),t}))),{connection:p.default});m.on("error",(e=>(r.default.error(e),e))),m.on("failed",(e=>(r.default.warn(e),e))),t.default=m},6909:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(7807),i=a(496),s=a(6517),l=a(6499),d=a(6645),r=a(6584),u=a(8216),c=a(1767),p=new n.Worker(l.QUEUES.CAMPAIGN_CALL,(e=>o(void 0,void 0,void 0,(function*(){d.default.info("Job Started Process Customer Call"),d.default.info(`${e.id} ${e.name}`);const t=e.data.campaignStep,a=e.data.audiences,n=e.data.company,c=t.campaign.audience_id,p=e.data.salesRecordings,m=l.CAMPAIGN_PHONE_NUMBERS_CALL_SEND;d.default.info(`Will call for ${t.step_name} of campaign ${t.campaign.campaign_name}`),d.default.info(`Sending Call to ${a.length}`);const f=(e=0)=>o(void 0,void 0,void 0,(function*(){if(e>=a.length)return;const o=s.slice(a,e,e+m);d.default.info(`Sending Batch Call to ${o.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const l=yield r.Models.CampaignStepLog.findAll({where:{audience_id:c,campaign_step_id:t.id,customer_id:{[i.Op.in]:s.map(o,"customer.id")}}}),y=s.xorBy(o,l,"customer_id");d.default.info(`After Filter: Sending Batch Call to ${y.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const _=new u.TwilioHelper(n.twilio_account_sid,n.twilio_auth_token),g=(yield _.makeVoiceCallOneByOne(y,p,n.full_twilio_phone),[]);return s.forEach(y,(e=>{g.push(r.Models.CampaignStepLog.create({campaign_step_id:t.id,audience_id:c,customer_id:e.customer_id}))})),yield Promise.all(g),e+=m,d.default.info(`Sent Batch Call to ${y.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`),f(e)}));return yield f(),e.id}))),{connection:c.default});p.on("completed",(e=>(d.default.info("Job Completed"),d.default.info(`${e.id} ${e.name}`),e))),p.on("error",(e=>(d.default.error("Job Error"),d.default.error(e),e))),p.on("failed",(e=>(d.default.error("Job Failed"),d.default.error(e),e))),t.default=p},2709:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(7807),i=a(496),s=a(6517),l=a(6499),d=a(6645),r=a(6584),u=a(9562),c=a(1767),p=new n.Worker(l.QUEUES.CAMPAIGN_EMAIL,(e=>o(void 0,void 0,void 0,(function*(){try{d.default.info("Job Started Process Customer Email"),d.default.info(`${e.id} ${e.name}`);const t=e.data.campaignStep,a=e.data.audiences,n=e.data.company,c=t.campaign.audience_id,p=e.data.salesTemplate,m=l.CAMPAIGN_PHONE_NUMBERS_EMAIL_SEND;d.default.info(`Will Email for ${t.step_name} of campaign ${t.campaign.campaign_name}`),d.default.info(`Sending Email to ${a.length}`);const f=(e=0)=>o(void 0,void 0,void 0,(function*(){if(e>=a.length)return;const o=s.slice(a,e,e+m);d.default.info(`Sending Batch Email to ${o.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const l=yield r.Models.CampaignStepLog.findAll({where:{audience_id:c,campaign_step_id:t.id,customer_id:{[i.Op.in]:s.map(o,"customer.id")}}}),y=s.xorBy(o,l,"customer_id");d.default.info(`After Filter: Sending Batch Email to ${y.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const _=u.default.emailUtils.getParamsForCampaign(y,p,n.emailSenders[0].email,n.id),g=(yield u.default.emailUtils.sendEmailForCampaign(_),[]);return s.forEach(y,(e=>{g.push(r.Models.CampaignStepLog.create({campaign_step_id:t.id,audience_id:c,customer_id:e.customer_id}))})),yield Promise.all(g),e+=m,d.default.info(`Sent Batch Email to ${y.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`),f(e)}));return yield f(),e.id}catch(e){return e}}))),{connection:c.default});p.on("completed",(e=>(d.default.info("Job Completed"),d.default.info(`${e.id} ${e.name}`),e))),p.on("error",(e=>(d.default.error("Job Error"),d.default.error(e),e))),p.on("failed",(e=>(d.default.error("Job Failed"),d.default.error(e),e))),t.default=p},992:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(7807),i=a(496),s=a(6517),l=a(6499),d=a(6645),r=a(6584),u=a(8216),c=a(1767),p=new n.Worker(l.QUEUES.CAMPAIGN_SMS,(e=>o(void 0,void 0,void 0,(function*(){d.default.info("Job Started Process Customer SMS"),d.default.info(`${e.id} ${e.name}`);const t=e.data.campaignStep,a=e.data.audiences,n=e.data.company,c=t.campaign.audience_id,p=e.data.salesTemplate,m=l.CAMPAIGN_PHONE_NUMBERS_SMS_SEND;d.default.info(`Will SMS for ${t.step_name} of campaign ${t.campaign.campaign_name}`),d.default.info(`Sending SMS to ${a.length}`);const f=(e=0)=>o(void 0,void 0,void 0,(function*(){if(e>=a.length)return;const o=s.slice(a,e,e+m);d.default.info(`Sending Batch SMS to ${o.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const l=yield r.Models.CampaignStepLog.findAll({where:{audience_id:c,campaign_step_id:t.id,customer_id:{[i.Op.in]:s.map(o,"customer.id")}}}),y=s.xorBy(o,l,"customer_id");d.default.info(`After Filter: Sending Batch SMS to ${y.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const _=new u.TwilioHelper(n.twilio_account_sid,n.twilio_auth_token),g=p.message,S=(yield _.makeSMSOneByOne(y,g,n.twilio_message_service_id),[]);return s.forEach(y,(e=>{S.push(r.Models.CampaignStepLog.create({campaign_step_id:t.id,audience_id:c,customer_id:e.customer_id}))})),yield Promise.all(S),e+=m,d.default.info(`Sent Batch SMS to ${y.length} for ${t.step_name} of campaign ${t.campaign.campaign_name}`),f(e)}));return yield f(),e.id}))),{connection:c.default});p.on("completed",(e=>(d.default.info("Job Completed"),d.default.info(`${e.id} ${e.name}`),e))),p.on("error",(e=>(d.default.error("Job Error"),d.default.error(e),e))),p.on("failed",(e=>(d.default.error("Job Failed"),d.default.error(e),e))),t.default=p},9684:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(7807),i=a(6499),s=a(6645),l=a(6584),d=a(3555),r=a(9190),u=a(1731),c=a(3174),p=a(3553),m=a(1767),f=e=>(0,d.isCampaignTypeCall)(e.step_campaign_type)&&(0,d.isContentTypeSalesBridge)(e.step_campaign_content_type),y=e=>(0,d.isCampaignTypeSMS)(e.step_campaign_type)&&(0,d.isContentTypeSalesBridge)(e.step_campaign_content_type),_=e=>(0,d.isCampaignTypeEmail)(e.step_campaign_type)&&(0,d.isContentTypeSalesBridge)(e.step_campaign_content_type),g=(e,t=!1,a)=>{const o={is_deleted:!1};((0,d.isCampaignTypeCall)(a)||(0,d.isCampaignTypeSMS)(a))&&(o.is_optout_from_campaign=!1),(0,d.isCampaignTypeEmail)(a)&&(o.is_unsubscribe_from_campaign=!1);const n={where:{audience_id:e.campaign.audience_id},include:[{model:l.Models.Customer,as:"customer",where:o}]};return t&&(n.include[0].include=[{model:l.Models.CustomerAddress,as:"customerAddress"}]),n},S=new n.Worker(i.QUEUES.CAMPAING_STEP_TRIGGER,(e=>o(void 0,void 0,void 0,(function*(){try{s.default.info("Job Started Campaign Trigger"),s.default.info(`${e.id} ${e.name}`);const{campaignStep:t}=e.data;if(t||s.default.info(`No campaign step to process for campaign step ${t.id}`),t){s.default.info(`Will process ${t.step_name} of campaign ${t.campaign.campaign_name} of type ${t.step_campaign_type}`);const e=g(t,!1,t.step_campaign_type),a=[l.Models.AudienceCustomer.count(e),l.Models.Company.findOne({where:{id:t.campaign.company_id},include:[{model:l.Models.EmailSender,as:"emailSenders"}]}),f(t)?l.Models.SalesRecording.findAll({where:{sales_template_id:t.step_sales_template_id,is_deleted:!1,is_selected:!0}}):null,y(t)||_(t)?l.Models.SalesTemplate.findOne({where:{id:t.step_sales_template_id}}):null],[n,m,S,T]=yield Promise.all(a);s.default.info(`Found total ${n} to process for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const w=500;let h=0;const v=(e=0,a=0)=>o(void 0,void 0,void 0,(function*(){if(s.default.info(`Looking for customers in page ${a} to process for ${t.step_name} of campaign ${t.campaign.campaign_name}`),e>=n)return s.default.info(`No more customers available to process for ${t.step_name} of campaign ${t.campaign.campaign_name}`),n;const o=a&&parseInt(a.toString())>=0?parseInt(a.toString()):0,f=(0,d.getPagination)(o,w?parseInt(w.toString()):20),y=g(t,!0,t.step_campaign_type),_=yield l.Models.AudienceCustomer.findAll(Object.assign(Object.assign({},y),{limit:f.limit,offset:f.offset}));s.default.info(`Will add ${_.length} in queue to process for ${t.step_name} of campaign ${t.campaign.campaign_name}`);const C={audiences:_,campaignStep:t,company:m,salesRecordings:S,salesTemplate:T},E=Object.assign(Object.assign({},i.RETRY_CONFIG),{delay:h});return(0,d.isCampaignTypeCall)(t.step_campaign_type)?(r.default.add(i.JOB_NAMES.CAMPAIGN.PROCESS_CALLS,C,E),h+=p.MINIMUM_DELAY_IN_PROCESSING_CUSTOMERS_JOBS_IN_SECONDS):(0,d.isCampaignTypeSMS)(t.step_campaign_type)?(u.default.add(i.JOB_NAMES.CAMPAIGN.PROCESS_SMS,C,E),h+=p.MINIMUM_DELAY_IN_PROCESSING_CUSTOMERS_JOBS_IN_SECONDS):(0,d.isCampaignTypeEmail)(t.step_campaign_type)&&(c.default.add(i.JOB_NAMES.CAMPAIGN.PROCESS_EMAIL,C,E),h+=p.MINIMUM_DELAY_IN_PROCESSING_CUSTOMERS_JOBS_IN_SECONDS),v(e+=w,a+=1)}));yield v()}return t}catch(t){throw s.default.error(`Error occurred while processing job ${e.id} ${e.name}`),t}}))),{connection:m.default});S.on("completed",(e=>(s.default.info("Job Completed"),s.default.info(`${e.id} ${e.name}`),e))),S.on("error",(e=>(s.default.error("Job Error"),s.default.error(e),e))),S.on("failed",(e=>(s.default.error("Job Failed"),s.default.error(e),e))),t.default=S},6160:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(7807),i=a(5828),s=a(6517),l=a(6499),d=a(6645),r=a(3553),u=a(6584),c=a(1767),p=new n.Worker(l.QUEUES.CUSTOMER_ADD,(e=>o(void 0,void 0,void 0,(function*(){d.default.info("Job Started Customer CSV Processing"),d.default.info(`${e.id} ${e.name}`),d.default.info(`Adding customers ${e.data.customers.length}`);const t=r.CONTACT_CREATE_PROMISE_BATCH_RECORDS,a=e.data.tagId,n=e.data.companyId,i=e.data.customers,l=(e=0)=>o(void 0,void 0,void 0,(function*(){if(e>=i.length)return;let o=s.slice(i,e,e+t);d.default.info(`Creating customers ${o.length} for ${n}`);const r=yield m(o,n,a);return d.default.info(`Creating customer address and product ${o.length} for ${n}`),yield f(r,o),d.default.info(`Inserted ${r.length} for ${n}`),l(e+=t)}));return yield l(),d.default.info(`Customers successfully created for company ${n}`),{}}))),{connection:c.default});p.on("completed",(e=>(d.default.info("Job Completed"),d.default.info(`${e.id} ${e.name}`),e))),p.on("error",(e=>(d.default.error("Job Error"),d.default.error(e),e))),p.on("failed",(e=>(d.default.error("Job Failed"),d.default.error(e),e)));const m=(e,t,a)=>o(void 0,void 0,void 0,(function*(){const o=[];return s.forEach(e,(e=>{o.push({id:(0,i.v4)(),first_name:e.firstname,last_name:e.lastname,name:e.fullname,email:e.email,country_code:e.country_code,mobile:e.phone,customer_from:"",company_id:t,tag_id:a,customer_company_name:e.company_name,customer_job_title:e.job_title})})),u.Models.Customer.bulkCreate(o)})),f=(e,t)=>o(void 0,void 0,void 0,(function*(){const a=[],o=[];return s.forEach(t,((t,n)=>{const l=Object.assign(Object.assign({id:(0,i.v4)()},(e=>{let t={};if(e.full_address&&""!==e.full_address.trim()){const a=s.reverse(s.split(e.full_address,","));if(a.length){let[e,o,n,i,...s]=a;t.country=e?e.trim():"",t.zipCode=parseInt(o)||0,t.state=n?n.trim():"",t.city=i?i.trim():"",t.address=s&&s.length?s.join(", "):""}}else t.address=e.address,t.city=e.city,t.state=e.state,t.zipCode=parseInt(e.zip)||0,t.country=e.country;return t})(t)),{customer_id:e[n].id,longitude:null,latitude:null});a.push(l),o.push({id:(0,i.v4)(),order_code:"",product_name:t.product_name,sales_amount:parseFloat(t.sales_amount)||0,customer_id:e[n].id})})),Promise.all([u.Models.CustomerAddress.bulkCreate(a),u.Models.CustomerProduct.bulkCreate(o)])}));t.default=p},7372:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(5828),i=a(496),s=a(8268),l=a(6584),d=a(2720),r=a(3555),u=a(3553),c=a(5303),p=a(6499),m=(0,s.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){if("superuser"!==e.user.roleType)return a(new d.default("You do not have permission to access this page",400));const{page:o,count:n,filters:s}=e.query,u=o&&r.parseIntNumber(o.toString())>=0?r.parseIntNumber(o.toString()):0,c=r.getPagination(u,n?r.parseIntNumber(n.toString()):20),p=r.getQueryBuilder(s),m=Object.assign(Object.assign({},p),{company_id:e.user.company_id}),[f,y]=yield Promise.all([l.Models.Audience.findAll({where:m,limit:c.limit,offset:c.offset,order:[["createdAt","desc"]],attributes:["*",[i.Sequelize.fn("COUNT",i.Sequelize.col("audiencesCustomers.audience_id")),"audiencesCustomers"]],include:[{duplicating:!1,model:l.Models.AudienceCustomer,attributes:[],as:"audiencesCustomers",include:[{model:l.Models.Customer,attributes:[],as:"customer",where:{is_deleted:!1}}]}],group:["Audience.id"],raw:!0}),l.Models.Audience.count({where:m})]);return t.status(200).json({total:y,audiences:f})})))),f=(0,s.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if("superuser"!==e.user.roleType)return a(new d.default("You do not have permission to create audience list",400));if(!r.getTrim(e.body.audience_name))return a(new d.default("Please provide a audience name!",400));const o=yield l.Models.Audience.create({id:(0,n.v4)(),audience_name:e.body.audience_name,company_id:e.user.company_id,status:u.AUDIENCE_STATUS.ACTIVE,creation_status:u.AUDIENCE_CREATION_STATUS.INPROGRESS,last_sync_at:(new Date).toISOString(),filters:e.body.filters||{}});return c.default.add(p.JOB_NAMES.AUDIENCE.PROCESS_AUDIENCE_ALL,{audience:o,filters:e.body.filters,companyId:e.user.company_id}),t.status(200).json({audience:o})}catch(e){a(e)}})))),y=(0,s.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const{id:a}=e.params,o=yield l.Models.Audience.findOne({where:{id:a}});return t.status(200).json(o)}))));t.default={getAudienceList:m,getAudienceDetail:y,addAudienceList:f}},4868:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(9344),i=a(5828),s=a(8432),l=a(6584),d=a(2720),r=a(8268),u=a(3555),c=(0,r.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){let t;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")&&(t=e.headers.authorization.split(" ")[1]),!t)return a(new d.default("You are not logged In ! Please log in to get access.",401));const o=n.verify(t,process.env.JWT_SECRET),i=yield l.Models.User.findByPk(o.payload.id);if(!i)return a(new d.default("The user belonging to this token does not exist.",401));e.user=i,a()})))),p=(0,r.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const{email:o,password:i}=e.body;if(!o)return a(new d.default("Please provide a email!",400));if(!i)return a(new d.default("Please provide a password!",400));const r=yield l.Models.User.findOne({where:{email:o},include:{model:l.Models.Company,as:"companyInfo"}});if(!r)return a(new d.default("Incorrect email! please try again.",401));if(!(yield s.compare(i,r.password)))return a(new d.default("Incorrect password! please try again.",401));const u=(e=>n.sign({payload:{id:e.id,nom:e.name,email:e.email}},process.env.JWT_SECRET,{expiresIn:process.env.JWT_EXPIRES_IN}))({id:r.id,name:r.name,email:r.email,company:r.companyInfo?r.companyInfo.name:""});t.status(200).json({status:"success",token:u})})))),m=(0,r.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if(!e.body.name)return a(new d.default("Please Provide Your Full Name!",401));if(!e.body.email)return a(new d.default("Please Provide your email!",401));if(!e.body.company)return a(new d.default("Please Provide your company!",401));if(!e.body.password)return a(new d.default("Please Provide your password!",401));if(!e.body.passwordConfirm||e.body.passwordConfirm!==e.body.password)return a(new d.default("Please confirm your password!",401));const o=yield s.hash(e.body.password,12);e.body.password=o;let n=yield l.Models.Company.findOne({where:{name:u.getTrimAndLowerCase(e.body.company)}});n||(n=yield l.Models.Company.create({id:(0,i.v4)(),name:u.getTrimAndLowerCase(e.body.company),address:u.getTrimAndLowerCase(e.body.address),city:u.getTrimAndLowerCase(e.body.city),zipCode:e.body.zipCode}));const r=yield l.Models.User.create({id:(0,i.v4)(),name:e.body.name,email:e.body.email,password:e.body.password,roleType:"superuser",company_id:n.id});if(!r)return a(new d.default("Invalid fields or duplicate user",401));t.status(201).json({status:"success",user:r.id})}catch(e){t.status(400).json({status:"false",error:e.message})}}))));t.default={protect:c,restrictTo:(...e)=>(t,a,o)=>{if(!e.includes(t.user.roleType))return o(new d.default("You do not have permission to perform this action",403));o()},login:p,signup:m}},198:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(5828),i=a(496),s=a(6584),l=a(8268),d=a(3555),r=e=>o(void 0,void 0,void 0,(function*(){return yield s.Models.CallLogs.create({id:(0,n.v4)(),log_description:e.log_description,customer_id:e.customer_id,user_id:e.user_id,company_id:e.company_id})})),u=(0,l.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{const a=e.body;if(a.extra&&a.extra.mobile&&!a.extra.notSave&&a.log_description){const o=yield s.Models.Customer.findOne({where:(0,i.where)((0,i.fn)("CONCAT",(0,i.col)("country_code"),(0,i.col)("mobile")),i.Op.eq,a.extra.mobile),attributes:["id"],raw:!0});return o?(yield r({id:(0,n.v4)(),log_description:e.body.log_description,customer_id:o.id,user_id:e.user.id,company_id:d.Role.isSuperUserOrManagement(e.user)?e.user.company_id:null}),t.status(200).json({})):t.status(200).json({})}return t.status(200).json({})}catch(e){return a(e)}}))));t.default={addLog:r,addLogRoute:u}},7906:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CampaignController=void 0;const n=a(5828),i=a(6517),s=a(496),l=a(2245),d=a(9141),r=a(8268),u=a(6584),c=a(2720),p=a(3555),m=a(3553),f=a(6499),y=a(1036),_=a(6645),g=a(9644),S=(0,r.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){if("superuser"!==e.user.roleType)return a(new c.default("You do not have permission to access this page",400));const{page:o,count:n,filters:i}=e.query,s=o&&p.parseIntNumber(o.toString())>=0?p.parseIntNumber(o.toString()):0,l=p.getPagination(s,n?p.parseIntNumber(n.toString()):20),d=p.getQueryBuilder(i),r=Object.assign(Object.assign({},d),{company_id:e.user.company_id}),[m,f]=yield Promise.all([u.Models.Campaign.findAll({where:r,limit:l.limit,offset:l.offset,order:[["createdAt","desc"]],include:[{model:u.Models.Audience,as:"audiences",attributes:["audience_name"]}]}),u.Models.Campaign.count({where:r})]);return t.status(200).json({total:f,campaigns:m})})))),T=(0,r.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if("superuser"!==e.user.roleType)return a(new c.default("You do not have permission to create campaign",400));if(!p.getTrim(e.body.campaign_name))return a(new c.default("Please provide a campaign name!",400));if(!p.getTrim(e.body.audience_id))return a(new c.default("Please provide a audience!",400));if(!i.isArray(e.body.campaign_steps)||!e.body.campaign_steps.length)return a(new c.default("Please provide atleast 1 campaign step!",400));const S=yield(s=e.body.campaign_steps,r=e.user.company_id,o(void 0,void 0,void 0,(function*(){const e=[];for(const t of s)i.isEmpty(p.getTrim(t.step_name))&&e.push(`Step "${t.step_name}" Name is required`),i.isEmpty(p.getTrim(t.step_delay_time))&&e.push(`Step "${t.step_name}" Delay time is required`),p.getTrim(t.step_delay_time)!==y.StepCampaignDelayTime.IMMEDIATELY&&i.isEmpty(p.getTrim(t.step_delay_value))&&e.push(`Step "${t.step_name}" Delay value is required`),p.getTrim(t.step_delay_time)===y.StepCampaignDelayTime.MINUTES&&parseInt(t.step_delay_value)<m.MINIMUM_DELAY_TIME_FOR_MINUTES&&e.push(`Step "${t.step_name}" Delay value must be minimum ${m.MINIMUM_DELAY_TIME_FOR_MINUTES} minutes`),!i.isEmpty(p.getTrim(t.step_campaign_type))&&i.includes(i.values(y.StepCampaignType),p.getTrim(t.step_campaign_type))||e.push(`Step "${t.step_name}" Campaign Type is required`),!i.isEmpty(p.getTrim(t.step_content_type))&&i.includes(i.values(y.StepCampaignContentType),p.getTrim(t.step_content_type))||e.push(`Step "${t.step_name}" Content Type is required`),p.getTrim(t.step_content_type)!==y.StepCampaignContentType.SALES_BRIDGE&&e.push(`Step "${t.step_name}" Content Type can only be sales bridge for now`),p.isContentTypeSalesBridge(t.step_content_type)&&i.isEmpty(p.getTrim(t.step_sales_template))&&e.push(`Step "${t.step_name}" Sales bridge template is required`),p.isCampaignTypeCall(t.step_campaign_type)&&p.isContentTypeSalesBridge(t.step_content_type)&&!i.isEmpty(p.getTrim(t.step_sales_template))&&0===(yield u.Models.SalesRecording.count({where:{sales_template_id:t.step_sales_template,is_deleted:!1,is_selected:!0}}))&&e.push(`Step "${t.step_name}" Sales bridge template does not have any audio recordings.`),p.isCampaignTypeEmail(t.step_campaign_type)&&0===(yield u.Models.EmailSender.count({where:{company_id:r}}))&&e.push(`Step "${t.step_name}" No email senders found for company.`);return e})));if(S.length)return a(new c.default(i.join(S,", "),400));if(!(yield u.Models.Audience.findOne({where:{id:e.body.audience_id}})))return a(new c.default("Please provide a valid audience!",400));const T=yield d.default.transaction((t=>o(void 0,void 0,void 0,(function*(){const a=yield u.Models.Campaign.create({id:(0,n.v4)(),campaign_name:e.body.campaign_name,company_id:e.user.company_id,audience_id:e.body.audience_id,status:m.CAMPAIGN_STATUS.ACTIVE,createdBy:e.user.id,updatedBy:e.user.id},{transaction:t}),o=[];i.forEach(e.body.campaign_steps,((e,n)=>{o.push(u.Models.CampaignStep.create({campaign_id:a.id,step_name:p.getTrim(e.step_name),step_index:parseInt(n),step_campaign_type:p.getTrim(e.step_campaign_type),step_campaign_content_type:p.getTrim(e.step_content_type),step_delay_time:p.getTrim(e.step_delay_time),step_delay_value:p.getTrim(e.step_delay_value),step_sales_template_id:p.getTrim(e.step_sales_template)},{transaction:t}))}));const s=yield Promise.all(o),d=[];let r=0,c=0,S=p.getRoundTimeCeil(new Date,l.duration(m.MINIMUM_DELAY_IN_JOBS_IN_SECONDS,"minutes")).toISOString();return i.forEach(s,(e=>{const o=e.toJSON(),n=o.step_delay_time===y.StepCampaignDelayTime.IMMEDIATELY;if(o.step_index===r&&n)g.default.add(f.JOB_NAMES.CAMPAIGN.PROCESS_CAMPAING_STEP_TRIGGER,{campaignStep:Object.assign(Object.assign({},o),{campaign:a})},{delay:c}),c+=m.MINIMUM_DELAY_IN_IMMEDIATE_JOBS_IN_SECONDS,r++;else{if(!n){const e=parseInt(o.step_delay_value);S=l(S).add(e,o.step_delay_time).toISOString()}_.default.info(S),d.push(u.Models.CampaignStepTrigger.create({campaign_step_id:o.id,trigger_at:S},{transaction:t}))}})),yield Promise.all(d),a}))));return t.status(200).json({campaign:T})}catch(e){a(e)}var s,r}))));t.CampaignController={getCampaignsList:S,addCampaign:T,runCampaignTriggerCron:()=>o(void 0,void 0,void 0,(function*(){try{_.default.info("Checking for campaign that needs to be trigged"),_.default.info(l().subtract(m.MINIMUM_DELAY_IN_JOBS_IN_SECONDS,"minutes").toISOString()),_.default.info(l().toISOString());const e=yield u.Models.CampaignStepTrigger.findAll({where:{trigger_at:{[s.Op.gte]:l().subtract(m.MINIMUM_DELAY_IN_JOBS_IN_SECONDS,"minutes").toISOString(),[s.Op.lte]:l().toISOString()}},include:[{required:!0,model:u.Models.CampaignStep,as:"campaignStep",attributes:["id","campaign_id","step_name","step_campaign_type","step_campaign_content_type","step_sales_template_id"],include:[{model:u.Models.Campaign,as:"campaign",where:{status:m.CAMPAIGN_STATUS.ACTIVE},attributes:["campaign_name","audience_id","company_id"]}]}]});_.default.info(`${e.length} campaigns steps found to trigger`);let t=0;return i.forEach(e,(e=>{g.default.add(f.JOB_NAMES.CAMPAIGN.PROCESS_CAMPAING_STEP_TRIGGER,{campaignStep:e.campaignStep},{delay:t}),t+=m.MINIMUM_DELAY_IN_IMMEDIATE_JOBS_IN_SECONDS})),e}catch(e){throw _.default.error(e),e}})),unsubscribeCompany:(e,t,a)=>o(void 0,void 0,void 0,(function*(){var o;try{const a=p.decodeBase64(e.query.co?null===(o=e.query.co)||void 0===o?void 0:o.toString():""),n=p.decodeBase64(e.query.cu?e.query.cu.toString():"");let i="";if(a&&n){const e=yield u.Models.Customer.findOne({where:{id:n,company_id:a}});e?e.is_unsubscribe_from_campaign?i="Already unsubsribed":(yield u.Models.Customer.update({is_unsubscribe_from_campaign:!0},{where:{id:n}}),i="Successfully unsubsribed"):i="Not found"}t.send({message:i})}catch(e){return a(e)}}))}},8258:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(5828),i=a(3837),s=a(6517),l=a(496),d=a(8268),r=a(6584),u=a(2720),c=a(3555),p=a(3553),m=a(9562),f=(e,t)=>{const a=[];return s.forEach(e,(e=>{s.isString(e.url)&&a.push(r.Models.SalesRecording.create({id:(0,n.v4)(),url:e.url,sales_template_id:t.id,is_selected:e.isSelected||!1,is_deleted:!1}))})),a},y=e=>{const t=[];return s.forEach(e,(e=>{t.push(r.Models.SalesRecording.update({is_selected:e.isSelected||!1},{where:{id:e.id}}))})),t},_=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){if("superuser"!==e.user.roleType)return a(new u.default("You do not have permission to access this page",400));const o=yield r.Models.Company.findOne({where:{id:e.user.company_id},include:[{model:r.Models.EmailSender,as:"emailSenders"}]});return t.status(200).json({companyDetails:o})})))),g=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){if(!e.body.company_id)return a(new u.default("You are not allowed to update company settings",400));const o=yield r.Models.Company.findOne({where:{id:e.body.company_id},include:[{model:r.Models.EmailSender,as:"emailSenders"}]});return o?"superuser"!==e.user.roleType&&e.user.company_id!==e.body.company_id?a(new u.default("You are not allowed to update company settings",400)):e.body.name?e.body.industry_id?e.body.country_code?e.body.twilio_phone?e.body.twilio_message_service_id?e.body.twilio_twiml_app_id?e.body.twilio_api_key?e.body.twilio_api_secret?e.body.twilio_account_sid?e.body.twilio_auth_token?e.body.address?e.body.city?e.body.zipCode?e.body.state?e.body.country?(yield r.Models.Company.update({name:e.body.name,industry_id:e.body.industry_id,country_code:e.body.country_code,twilio_message_service_id:e.body.twilio_message_service_id,twilio_twiml_app_id:e.body.twilio_twiml_app_id,twilio_api_key:e.body.twilio_api_key,twilio_api_secret:e.body.twilio_api_secret,twilio_account_sid:e.body.twilio_account_sid,twilio_auth_token:e.body.twilio_auth_token,twilio_phone:e.body.twilio_phone,address:e.body.address,city:e.body.city,zipCode:e.body.zipCode,state:e.body.state,country:e.body.country},{where:{id:e.body.company_id}}),o.emailSenders.length?yield r.Models.EmailSender.update({email:e.body.from_email},{where:{id:o.emailSenders[0].id}}):yield r.Models.EmailSender.create({id:(0,n.v4)(),company_id:o.id,email:e.body.from_email}),void t.status(201).json({status:"success"})):a(new u.default("Please Provide Country!",400)):a(new u.default("Please Provide State!",400)):a(new u.default("Please Provide Zip Code!",400)):a(new u.default("Please Provide City!",400)):a(new u.default("Please Provide Address!",400)):a(new u.default("Please Provide Twilio Auth token!",400)):a(new u.default("Please Provide Twilio Account Sid!",400)):a(new u.default("Please Provide Twilio API Secret!",400)):a(new u.default("Please Provide Twilio API Key!",400)):a(new u.default("Please Provide Twilio TwiML App Id!",400)):a(new u.default("Please Provide Twilio Message Service Id!",400)):a(new u.default("Please Provide Twilio Phone!",400)):a(new u.default("Please Provide Country code!",400)):a(new u.default("Please Provide industry!",400)):a(new u.default("Please Provide Company Name!",400)):a(new u.default("Company not found",400))})))),S=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){var o;if("superuser"!==e.user.roleType)return a(new u.default("You do not have permission to access this page",400));const{page:n,count:i,filters:s}=e.query,l=n&&c.parseIntNumber(n.toString())>=0?c.parseIntNumber(n.toString()):0,d=c.getPagination(l,i?c.parseIntNumber(i.toString()):20),m=c.getQueryBuilder(s),f=Object.assign(Object.assign({},m),{company_id:e.user.company_id});e.query.type&&(null===(o=e.query.type)||void 0===o?void 0:o.toString().toLowerCase())!==p.TYPE_ALL&&(f.template_type=e.query.type);const[y,_]=yield Promise.all([r.Models.SalesTemplate.findAll({where:f,limit:d.limit,offset:d.offset,order:[["createdAt","desc"],[{model:r.Models.SalesRecording,as:"sales_recordings"},"createdAt","ASC"]],include:[{model:r.Models.SalesRecording,required:!1,as:"sales_recordings",where:{is_deleted:!1}}]}),r.Models.SalesTemplate.count({where:f})]);return t.status(200).json({total:_,templates:y})})))),T=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{const a=i.promisify(m.default.S3Utils.uploadAudioFiles);return yield a(e,t),t.status(200).send(s.map(e.files,(e=>({name:e.originalname,url:e.location}))))}catch(e){return a("string"==typeof e?new u.default(e,400):e)}})))),w=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if("superuser"!==e.user.roleType)return a(new u.default("You do not have permission to access this page",400));const o=yield r.Models.SalesTemplate.findOne({where:{id:e.params.id,company_id:e.user.company_id},order:[[{model:r.Models.SalesRecording,as:"sales_recordings"},"createdAt","ASC"]],include:[{model:r.Models.SalesRecording,required:!1,as:"sales_recordings",where:{is_deleted:!1}}]});return t.status(200).json({template:o})}catch(e){a(e)}})))),h=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if("superuser"!==e.user.roleType)return a(new u.default("You do not have permission to edit sales templates",400));const o=yield r.Models.SalesTemplate.findOne({where:{id:e.params.id}});if(!o)return a(new u.default("Invalid template!",400));if(o.company_id!==e.user.company_id)return a(new u.default("You do not have permission to edit this sales template!",400));if(!c.getTrim(e.body.template_name))return a(new u.default("Please provide a template name!",400));if(!c.getTrim(e.body.message))return a(new u.default("Please provide a template message!",400));if(c.isTemplateTypeEmail(e.body.template_type)&&!c.getTrim(e.body.email_subject))return a(new u.default("Please provide a email subject!",400));if(!c.isValidTemplateType(e.body.template_type))return a(new u.default("Please provide a valid template type!",400));yield r.Models.SalesTemplate.update({template_name:e.body.template_name,message:e.body.message,email_subject:e.body.email_subject,updatedBy:e.user.id},{where:{id:o.id}});const n=s.map(e.body.files,"id");if(n.length){const t=yield r.Models.SalesRecording.findAll({where:{id:{[l.Op.in]:n}}}),a=[...e.body.files],i=s.remove(a,(e=>s.find(t,{id:e.id})));yield Promise.all([f(a,o),y(i)])}return t.status(200).json({message:"Sales template updated successfully",template:o})}catch(e){a(e)}})))),v=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if("superuser"!==e.user.roleType)return a(new u.default("You do not have permission to create sales templates",400));if(!c.getTrim(e.body.template_name))return a(new u.default("Please provide a template name!",400));if(c.isTemplateTypeEmail(e.body.template_type)&&!c.getTrim(e.body.email_subject))return a(new u.default("Please provide a email subject!",400));if(!c.getTrim(e.body.message))return a(new u.default("Please provide a template message!",400));if(!c.isValidTemplateType(e.body.template_type))return a(new u.default("Please provide a valid template type!",400));const o=yield r.Models.SalesTemplate.create({id:(0,n.v4)(),template_name:e.body.template_name,template_type:e.body.template_type,message:e.body.message,email_subject:e.body.email_subject,company_id:e.user.company_id,createdBy:e.user.id,updatedBy:e.user.id});if(e.body.files&&e.body.files.length){const t=f(e.body.files,o);yield Promise.all(t)}return t.status(200).json({message:"Sales template created successfully",template:o})}catch(e){a(e)}})))),C=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{return"superuser"!==e.user.roleType?a(new u.default("You do not have permission to perform this action",400)):(yield r.Models.SalesRecording.update({is_deleted:!0},{where:{id:e.params.id}}),t.status(200).json({message:"Recording deleted successfully"}))}catch(e){a(e)}}))));t.default={getCompanyDetails:_,updateCompanySettings:g,getCompanySalesTemplates:S,uploadAudioToS3:T,getCompanySalesTemplateDetails:w,updateCompanySalesTemplates:h,addCompanySalesTemplates:v,deleteAudioRecording:C}},7651:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CustomerController=void 0;const n=a(5828),i=a(496),s=a(3837),l=a(7147),d=a(8160),r=a(6517),u=a(6584),c=a(8268),p=a(3555),m=a(2720),f=a(8176),y=a(6499),_=a(3553),g=(0,s.promisify)(l.unlink),S=(0,c.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const{name:a,mobile:o,customer_from:i,country_code:s,longitude:l,latitude:d,address:c,city:p,zipCode:m,order_code:f,remarks:y}=e.body,_=r.split(a," "),g=yield u.Models.Customer.create({id:(0,n.v4)(),name:a,first_name:_.length?_[0]:"",last_name:_.length?_[1]:"",email:"",mobile:o,customer_from:i,country_code:s,company_id:e.user.company_id}),S=yield u.Models.CustomerAddress.create({id:(0,n.v4)(),address:c,city:p,zipCode:m,customer_id:g.id,longitude:l,latitude:d}),T=yield u.Models.CustomerProduct.create({id:(0,n.v4)(),order_code:f,product_name:"",sales_amount:0,remarks:y,customer_id:g.id});return t.status(200).json({error:!1,message:"customer create successfully",customer:g,customerAddress:S,customerProduct:T})})))),T=e=>o(void 0,void 0,void 0,(function*(){const{page:t,count:a,filters:o,attributes:n,companyId:i}=e,s=t&&parseInt(t.toString())>=0?parseInt(t.toString()):0,l=p.getPagination(s,a?parseInt(a.toString()):20),d=p.getQueryBuilder(o);i&&(d.company_id=i),d.is_deleted=!1;const r={where:d,limit:l.limit,offset:l.offset,order:[["createdAt","desc"]],include:[{model:u.Models.CustomerAddress,as:"customerAddress"}]};return n&&n.length&&(r.attributes=n),Promise.all([u.Models.Customer.findAll(r),u.Models.Customer.count({where:d})])})),w=(0,c.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const[a,o]=yield T({page:e.query.page.toString(),count:e.query.count.toString(),filters:e.query.filters,companyId:e.user.company_id});return t.status(200).json({total:o,customers:a})})))),h=(0,c.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const{id:a}=e.params,o=yield u.Models.Customer.findOne({where:{id:a},include:[{model:u.Models.CustomerProduct,as:"customerProduct"},{model:u.Models.CustomerAddress,as:"customerAddress"}]});return o?t.status(200).json(o):t.status(404).json({error:!0,message:"Element not found"})})))),v=(0,c.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const{id:a}=e.params,{name:o,mobile:n,customer_from:i,country_code:s,longitude:l,latitude:d,address:r,city:c,zipCode:p,order_code:m,remarks:f}=e.body,y=yield u.Models.Customer.findOne({where:{id:a},include:[{model:u.Models.CustomerProduct,as:"customerProduct"},{model:u.Models.CustomerAddress,as:"customerAddress"}]});return y?(o&&(y.name=o),n&&(y.mobile=n),s&&(y.country_code=s),i&&(y.customer_from=i),yield y.save(),r&&(y.customerAddress.address=r),c&&(y.customerAddress.city=c),p&&(y.customerAddress.zipCode=p),yield y.customerAddress.save(),m&&(y.customerProduct.order_code=m),f&&(y.customerProduct.remarks=f),yield y.customerProduct.save(),t.status(200).json({erorr:!1,message:"Customer information updated successfully"})):t.status(404).json({error:!0,message:"Element not found"})})))),C=(0,c.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{const{id:a}=e.params,o=(yield u.Models.Customer.findOne({where:{id:a},attributes:["id","name","country_code","mobile","full_mobile"]})).toJSON();if(o){const e=yield u.Models.Message.findAll({where:{[i.Op.or]:[{from_customer_id:a},{to_customer_id:a}]},include:[{model:u.Models.User,as:"users",attributes:["name"]}]});o.chats=e}return t.status(200).send(o)}catch(e){return a(e)}})))),E=(0,c.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if(!e.file)return a(new m.default("Please select a csv file",400));if(!p.isUUID(e.body.tag_id))return a(new m.default("Please provide select a tag!",400));const o=e.file,n=yield d().fromFile(o.path);return yield g(o.path),n.length>_.MAX_CUSTOMER_CSV_ALLOWED?a(new m.default(`Only ${_.MAX_CUSTOMER_CSV_ALLOWED.toLocaleString()} customers are allowed in a single csv file!`,400)):(f.default.add(y.JOB_NAMES.CUSTOMER.ADD,{customers:n,companyId:e.user.company_id,tagId:e.body.tag_id}),t.status(200).send({}))}catch(e){return a(e)}}))));t.CustomerController={createCustomer:S,listCustomers:w,getCustomerInformation:h,updateCustomerInformation:v,deleteCustomersSubscription:(e,t,a)=>o(void 0,void 0,void 0,(function*(){const{ids:a}=e.body;for(const e of a){const t=yield u.Models.Customer.findOne({where:{id:e},include:[{model:u.Models.CustomerProduct,as:"customerProduct"},{model:u.Models.CustomerAddress,as:"customerAddress"}]});t&&(t.customerProduct&&(yield t.customerProduct.destroy()),t.customerAddress&&(yield t.customerAddress.destroy()),t.is_deleted=!0,yield t.save())}return t.status(200).json({error:!1,message:"customers has been removed"})})),getCustomersChats:C,getCustomersData:T,uploadCSV:E}},8791:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(2720);t.default=(e,t,a,n)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error";{let n=Object.assign({},e);n.message=e.message,"JsonWebTokenError"===n.name&&(n=new o.default("Invalid token. Please log in again!",401)),"TokenExpiredError"===n.name&&(n=new o.default("Your token has expired! Please log in again.",401)),((e,t,a)=>{t.originalUrl.startsWith("/api")?e.isOperational?a.status(e.statusCode).json({status:e.status,message:e.message}):"SequelizeValidationError"===e.name?a.status(400).json({status:e.status,error:e,message:e.message,stack:e.stack}):"SequelizeUniqueConstraintError"===e.name?a.status(e.statusCode).json({status:e.status,message:e.message}):(console.error("ERROR 💥",e),a.status(500).json({status:"error",message:"Something went very wrong!"})):e.isOperational?(console.log(e),a.status(e.statusCode).render("error",{title:"Something went wrong!",msg:e.message})):(console.error("ERROR 💥",e),a.status(e.statusCode).render("error",{title:"Something went wrong!",msg:"Please try again later."}))})(n,t,a)}}},6361:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(6584),i=(0,a(8268).default)(((e,t)=>o(void 0,void 0,void 0,(function*(){const[e,a]=yield Promise.all([n.Models.Industry.findAll({}),n.Models.Industry.count({})]);return t.status(200).json({total:a,industries:e})}))));t.default={listIndustries:i}},8351:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(7202),i=a(496),s=a(6517),l=a(5828),d=a(6584),r=a(8268),u=a(2720),c=a(3555),p=a(198),m=a(3553),{AccessToken:f}=n.jwt,{VoiceGrant:y}=f,{VoiceResponse:_}=n.twiml,g=(0,r.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){var a;if(e.body.From&&e.body.Body&&e.body.To&&e.params.id){const[o,n,r]=yield Promise.all([d.Models.User.findOne({where:(0,i.where)((0,i.fn)("CONCAT",(0,i.col)("twilio_country_code"),(0,i.col)("twilio_phone")),i.Op.eq,e.body.To),attributes:["id"],raw:!0}),d.Models.Company.findOne({where:(0,i.where)((0,i.fn)("CONCAT",(0,i.col)("country_code"),(0,i.col)("twilio_phone")),i.Op.eq,e.body.To),attributes:["id"],raw:!0}),d.Models.Customer.findOne({where:{[i.Op.and]:[(0,i.where)((0,i.fn)("CONCAT",(0,i.col)("country_code"),(0,i.col)("mobile")),i.Op.eq,e.body.From),{company_id:e.params.id}]},attributes:["id"],raw:!0})]);if(!r)return t.status(204).json({status:"success"});const u={id:(0,l.v4)(),from:e.body.From,to:e.body.To,msg:e.body.Body,from_customer_id:r.id};n?u.company_id=n.id:o&&(u.user_id=o.id),n&&r&&s.includes(m.OPT_OUT_KEYWORDS,null===(a=e.body.Body)||void 0===a?void 0:a.trim().toLowerCase())&&(yield d.Models.Customer.update({is_optout_from_campaign:!0},{where:{id:r.id}})),yield d.Models.Message.create(u)}return t.status(200).json({status:"success"})})))),S=(0,r.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const e=yield d.Models.Message.findAll({});return e?t.status(200).json({status:"success",messages:e}):a(new u.default("No messages found.",404))}))));t.default={sendSMS:(e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if(!e.body.to_customer_id||!e.user.id)return a(new u.default("Invalid params",400));const o=new n.Twilio(e.user.companyInfo.twilio_account_sid,e.user.companyInfo.twilio_auth_token),i=e.body.to_customer_id,s=e.user.id,r=yield d.Models.Customer.findOne({where:{id:i},attributes:["id","country_code","mobile","full_mobile"]});if(!r)return a(new u.default("Invalid user",400));let p;return p=c.Role.isSuperUserOrManagement(e.user)?e.user.companyInfo.full_twilio_phone:e.user.full_twilio_phone,p?(yield o.messages.create({body:e.body.msg,to:r.full_mobile,from:p}),yield d.Models.Message.create({id:(0,l.v4)(),from:p,to:r.full_mobile,to_customer_id:r.id,user_id:s,company_id:c.Role.isSuperUserOrManagement(e.user)?e.user.company_id:null,msg:e.body.msg}),t.status(200).json({status:"success"})):a(new u.default(`Please specify a mobile number in ${c.Role.isSuperUserOrManagement(e.user)?"company":"user"} settings`,400))}catch(e){return a(e)}})),getAllmessages:S,receiveSMS:g,voiceResponse:(e,t,a)=>o(void 0,void 0,void 0,(function*(){const n=e.body.To,l=new _;let r;const f=s.split(e.body.From,":"),y=f.length?f[1]:null;if(e.body.To){const[t,f]=yield Promise.all([d.Models.Company.findOne({where:(0,i.where)((0,i.fn)("CONCAT",(0,i.col)("country_code"),(0,i.col)("twilio_phone")),i.Op.eq,e.body.To),attributes:["id"],raw:!0}),y?d.Models.User.findOne({where:{id:y},include:[{required:!1,model:d.Models.Company,as:"companyInfo"}]}):null]);if(t){const a=yield d.Models.User.findAll({where:{roleType:m.ALL_ROLES.SALES_REP,company_id:t.id},attributes:["id","mobile_country_code","mobile_phone","full_mobile_phone"]});r=l.dial(),s.forEach(a,(e=>r.client(e.id))),g=e.body.From,e.body.To,S=t,o(void 0,void 0,void 0,(function*(){try{const[e]=yield Promise.all([d.Models.Customer.findOne({where:(0,i.where)((0,i.fn)("CONCAT",(0,i.col)("country_code"),(0,i.col)("mobile")),i.Op.eq,g),attributes:["id"],raw:!0})]);e&&S&&(yield p.default.addLog({log_description:"Incoming call.",customer_id:e.id,company_id:S.id}))}catch(e){throw console.error(e),e}}))}else if(f){const e=f.companyInfo.full_twilio_phone;if(!e)return a(new u.default(`Please specify a mobile number in ${c.Role.isSuperUserOrManagement(f)?"company":"user"} settings`,400));r=l.dial({callerId:e}),r.number(n)}}else l.say("Thanks for calling!");var g,S;t.set("Content-Type","text/xml"),t.send(l.toString())})),generateToken:(e,t,a)=>o(void 0,void 0,void 0,(function*(){try{const{id:a}=e.user;let o="";if(e.user.companyInfo.twilio_account_sid&&e.user.companyInfo.twilio_api_key&&e.user.companyInfo.twilio_api_secret){const t=new f(e.user.companyInfo.twilio_account_sid,e.user.companyInfo.twilio_api_key,e.user.companyInfo.twilio_api_secret);t.identity=a;const n=new y({outgoingApplicationSid:e.user.companyInfo.twilio_twiml_app_id,incomingAllow:!0});t.addGrant(n),o=t.toJwt()}return t.status(200).send({token:o})}catch(e){return a(e)}}))}},446:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.TagsController=void 0;const n=a(5828),i=a(8268),s=a(6584),l=a(2720),d=a(3555),r=(0,i.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){const{page:a,count:o,filters:n}=e.query,i=a&&d.parseIntNumber(a.toString())>=0?d.parseIntNumber(a.toString()):0,l=d.getPagination(i,o?d.parseIntNumber(o.toString()):20),r=d.getQueryBuilder(n),u=Object.assign(Object.assign({},r),{company_id:e.user.company_id}),[c,p]=yield Promise.all([s.Models.CustomerTag.findAll({where:u,limit:l.limit,offset:l.offset,order:[["createdAt","desc"]]}),s.Models.CustomerTag.count({where:u})]);return t.status(200).json({total:p,tags:c})})))),u=(0,i.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if(!d.getTrim(e.body.tag_name))return a(new l.default("Please provide a tag name!",400));const o=yield s.Models.CustomerTag.create({id:(0,n.v4)(),tag_name:e.body.tag_name.trim(),company_id:e.user.company_id});return t.status(200).json({tag:o})}catch(e){a(e)}})))),c=(0,i.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){try{if(!d.getTrim(e.body.tag_name))return a(new l.default("Please provide a tag name!",400));const o=yield s.Models.CustomerTag.findOne({where:{id:e.params.id}});return o?o.company_id!==e.user.company_id?a(new l.default("You do not have permission to edit this tag!",400)):(yield s.Models.CustomerTag.update({tag_name:e.body.tag_name},{where:{id:o.id}}),t.status(200).json({})):a(new l.default("Invalid tag!",400))}catch(e){a(e)}}))));t.TagsController={getTagsList:r,addTag:u,editTag:c}},5587:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(5828),i=a(8432),s=a(6584),l=a(2720),d=a(8268),r=a(3555),u=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){if("superuser"!==e.user.roleType)return a(new l.default("You are not allowed to see users",400));const{page:o,count:n,filters:i}=e.query,d=o&&parseInt(o,10)>=0?parseInt(o,10):0,u=r.getPagination(d,n?parseInt(n,10):20),c=r.getQueryBuilder(i),[p,m]=yield Promise.all([s.Models.User.findAll({where:Object.assign(Object.assign({},c),{company_id:e.user.company_id}),limit:u.limit,offset:u.offset,attributes:["id","name","is_active","roleType","createdAt","email","twilio_phone","mobile_phone","twilio_country_code","mobile_country_code"],order:[["createdAt","desc"]],include:[{model:s.Models.Company,as:"companyInfo"}]}),s.Models.User.count({where:Object.assign(Object.assign({},c),{company_id:e.user.company_id})})]);return t.status(200).json({total:m,users:p})})))),c=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){if(console.log(e.body),"superuser"!==e.user.roleType)return a(new l.default("You are not allowed to update user",400));const o={name:e.body.name,email:e.body.email,is_active:e.body.is_active,roleType:e.body.roleType,twilio_phone:e.body.twilio_phone,mobile_phone:e.body.mobile_phone,twilio_country_code:e.body.twilio_country_code,mobile_country_code:e.body.mobile_country_code};if(e.body.password&&""!==e.body.password.trim()){if(e.body.password!==e.body.confirmPassword)return a(new l.default("Pleace confirm the password !",400));const t=yield i.hash(e.body.password,12);o.password=t,delete e.body.confirmPassword}else delete e.body.password,delete e.body.confirmPassword;if(!(yield s.Models.User.update(o,{where:{id:e.params.id}})))return a(new l.default("Invalid fields or No user found with this ID",404));t.status(203).json({status:"success"})})))),p=(0,d.default)(((e,t,a)=>o(void 0,void 0,void 0,(function*(){if("superuser"!==e.user.roleType)return a(new l.default("You are not allowed to create user",400));if(!e.body.name)return a(new l.default("Please Provide Your Full Name!",400));if(!e.body.email)return a(new l.default("Please Provide your email!",400));if(!e.body.roleType)return a(new l.default("Please select a role!",400));if(!e.body.password)return a(new l.default("Please Provide your password!",400));if(!e.body.confirmPassword||e.body.confirmPassword!==e.body.password)return a(new l.default("Please confirm your password!",400));delete e.body.confirmPassword;const o=yield i.hash(e.body.password,12);if(e.body.password=o,!(yield s.Models.User.create({id:(0,n.v4)(),name:e.body.name,email:e.body.email,password:e.body.password,is_active:e.body.is_active||!1,twilio_phone:e.body.twilio_phone,mobile_phone:e.body.mobile_phone,twilio_country_code:e.body.twilio_country_code,mobile_country_code:e.body.mobile_country_code,company_id:e.user.company_id,roleType:e.body.roleType})))return a(new l.default("Invalid fields or duplicate user",400));t.status(201).json({status:"success"})}))));t.default={addUser:p,getAllUsers:u,updateUser:c}},4137:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getCampaignsToRun=void 0,a(5142).config();const n=a(7906),i=a(9141),s=a(6752),l=a(6645);t.getCampaignsToRun=()=>o(void 0,void 0,void 0,(function*(){try{yield i.default.authenticate(),new s.App,l.default.info("DB Connection has been established successfully."),l.default.info("Campaign Cron Running"),yield n.CampaignController.runCampaignTriggerCron()}catch(e){console.error(`Error starting DB server: ${e.message}`),process.exit(1)}})),(0,t.getCampaignsToRun)()},9141:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=new(a(496).Sequelize)({database:process.env.DB_NAME,username:process.env.DB_USERNAME,password:process.env.DB_PASSWORD,host:process.env.DB_HOSTNAME,port:parseInt(process.env.DB_PORT),dialect:"postgres",logging:!0,dialectOptions:{ssl:{require:!0,rejectUnauthorized:!1}}});t.default=o},5191:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141),i=a(3553);class s extends o.Model{}s.init({audience_name:{type:o.DataTypes.STRING,allowNull:!1},status:{type:o.DataTypes.ENUM,values:i.AUDIENCE_STATUS_ARRAY,allowNull:!1,defaultValue:i.AUDIENCE_STATUS.DEFAULT},creation_status:{type:o.DataTypes.ENUM,values:i.AUDIENCE_CREATION_STATUS_ARRAY,allowNull:!1,defaultValue:i.AUDIENCE_CREATION_STATUS.DEFAULT},filters:{type:o.DataTypes.JSON,allowNull:!1},last_sync_at:{type:o.DataTypes.DATE,allowNull:!1},company_id:{type:o.DataTypes.UUID,allowNull:!1}},{sequelize:n.default,modelName:"Audience",tableName:"audiences"}),t.default=s},2360:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},audience_id:{type:o.DataTypes.UUID,allowNull:!0},customer_id:{type:o.DataTypes.UUID,allowNull:!0}},{sequelize:n.default,modelName:"AudienceCustomer",tableName:"audience_customers"}),t.default=i},683:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({log_description:{type:o.DataTypes.STRING},customer_id:{type:o.DataTypes.UUID,allowNull:!0},user_id:{type:o.DataTypes.UUID,allowNull:!0},company_id:{type:o.DataTypes.UUID,allowNull:!0}},{sequelize:n.default,modelName:"CallLogs",tableName:"call_logs"}),t.default=i},4927:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},campaign_name:{type:o.DataTypes.STRING,allowNull:!1},audience_id:{type:o.DataTypes.UUID,allowNull:!1},company_id:{type:o.DataTypes.UUID,allowNull:!1},createdBy:{type:o.DataTypes.UUID,allowNull:!1},updatedBy:{type:o.DataTypes.UUID,allowNull:!1},status:{type:o.DataTypes.STRING,allowNull:!1}},{sequelize:n.default,modelName:"Campaign",tableName:"campaigns"}),t.default=i},1036:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StepCampaignContentType=t.StepCampaignDelayTime=t.StepCampaignType=void 0;const o=a(496),n=a(9141);var i,s,l;(l=t.StepCampaignType||(t.StepCampaignType={})).SMS="sms",l.CALL="call",l.EMAIL="email",(s=t.StepCampaignDelayTime||(t.StepCampaignDelayTime={})).IMMEDIATELY="immediately",s.MINUTES="minutes",s.HOURS="hours",s.DAYS="days",(i=t.StepCampaignContentType||(t.StepCampaignContentType={})).AUDIO="audio",i.IVR="ivr",i.DROP_RVM="drop_rvm",i.SALES_BRIDGE="sales_bridge";class d extends o.Model{}d.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},campaign_id:{type:o.DataTypes.UUID,allowNull:!1},step_name:{type:o.DataTypes.STRING,allowNull:!1},step_index:{type:o.DataTypes.INTEGER,allowNull:!1},step_delay_time:{type:o.DataTypes.STRING,allowNull:!1},step_delay_value:{type:o.DataTypes.STRING},step_campaign_type:{type:o.DataTypes.STRING,allowNull:!1},step_campaign_content_type:{type:o.DataTypes.STRING,allowNull:!1},step_sales_template_id:{type:o.DataTypes.UUID}},{sequelize:n.default,modelName:"CampaignStep",tableName:"campaign_steps"}),t.default=d},262:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},campaign_step_id:{type:o.DataTypes.UUID,allowNull:!1},audience_id:{type:o.DataTypes.UUID,allowNull:!1},customer_id:{type:o.DataTypes.UUID,allowNull:!1}},{sequelize:n.default,modelName:"CampaignStepLog",tableName:"campaign_step_logs"}),t.default=i},362:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},campaign_step_id:{type:o.DataTypes.UUID,allowNull:!1},trigger_at:{type:o.DataTypes.DATE,allowNull:!1}},{sequelize:n.default,modelName:"CampaignStepTrigger",tableName:"campaign_step_triggers"}),t.default=i},9760:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({name:{type:o.DataTypes.STRING,allowNull:!1,unique:{name:"name",msg:"Company name is taken!"}},address:{type:o.DataTypes.STRING(100),allowNull:!0},city:{type:o.DataTypes.STRING(50),allowNull:!0},zipCode:{type:o.DataTypes.INTEGER,allowNull:!0},longitude:{type:o.DataTypes.FLOAT,allowNull:!0},latitude:{type:o.DataTypes.FLOAT,allowNull:!0},twilio_phone:{type:o.DataTypes.STRING,allowNull:!0},country_code:{type:o.DataTypes.STRING,allowNull:!0},full_twilio_phone:{type:o.DataTypes.VIRTUAL,get(){const e=[];return this.country_code&&e.push(this.country_code),this.twilio_phone&&e.push(this.twilio_phone),e.join("")}},twilio_message_service_id:{type:o.DataTypes.STRING,allowNull:!0},twilio_twiml_app_id:{type:o.DataTypes.STRING,allowNull:!0},twilio_api_key:{type:o.DataTypes.STRING},twilio_api_secret:{type:o.DataTypes.STRING},twilio_account_sid:{type:o.DataTypes.STRING},twilio_auth_token:{type:o.DataTypes.STRING},state:{type:o.DataTypes.STRING,allowNull:!0},country:{type:o.DataTypes.STRING,allowNull:!0},industry_id:{type:o.DataTypes.UUID,allowNull:!0}},{sequelize:n.default,modelName:"Company",tableName:"companys"}),t.default=i},6895:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},name:{type:o.DataTypes.STRING,allowNull:!1},first_name:{type:o.DataTypes.STRING,allowNull:!1,defaultValue:""},last_name:{type:o.DataTypes.STRING,allowNull:!1,defaultValue:""},email:{type:o.DataTypes.STRING,allowNull:!1},country_code:{type:o.DataTypes.STRING,allowNull:!1},mobile:{type:o.DataTypes.STRING,allowNull:!1},full_mobile:{type:o.DataTypes.VIRTUAL,get(){const e=[];return this.country_code&&e.push(this.country_code),this.mobile&&e.push(this.mobile),e.join("")}},customer_from:{type:o.DataTypes.STRING,allowNull:!1},is_deleted:{type:o.DataTypes.BOOLEAN,defaultValue:!1},is_optout_from_campaign:{type:o.DataTypes.BOOLEAN,defaultValue:!1},is_unsubscribe_from_campaign:{type:o.DataTypes.BOOLEAN,defaultValue:!1},company_id:{type:o.DataTypes.UUID,allowNull:!1},tag_id:{type:o.DataTypes.UUID},customer_company_name:{type:o.DataTypes.STRING},customer_job_title:{type:o.DataTypes.STRING}},{sequelize:n.default,modelName:"Customer",tableName:"customers"}),t.default=i},6191:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},order_code:{type:o.DataTypes.STRING,allowNull:!1},product_name:{type:o.DataTypes.STRING,allowNull:!1},sales_amount:{type:o.DataTypes.FLOAT,allowNull:!1},customer_id:{type:o.DataTypes.UUID,allowNull:!1},remarks:{type:o.DataTypes.STRING}},{sequelize:n.default,modelName:"CustomerProduct",tableName:"customer_products"}),t.default=i},1199:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({tag_name:{type:o.DataTypes.STRING,allowNull:!1},company_id:{allowNull:!1,type:o.DataTypes.UUID}},{sequelize:n.default,modelName:"CustomerTags",tableName:"customer_tags"}),t.default=i},3886:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},address:{allowNull:!1,type:o.DataTypes.STRING},city:{type:o.DataTypes.STRING,allowNull:!1},state:{type:o.DataTypes.STRING},zipCode:{type:o.DataTypes.INTEGER,allowNull:!1},country:{type:o.DataTypes.STRING},longitude:{type:o.DataTypes.FLOAT,allowNull:!0},latitude:{type:o.DataTypes.FLOAT,allowNull:!0},customer_id:{type:o.DataTypes.UUID,allowNull:!1}},{sequelize:n.default,modelName:"CustomerAddress",tableName:"customer_address"}),t.default=i},4828:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TemplateType=void 0;const o=a(496),n=a(9141);var i;(i=t.TemplateType||(t.TemplateType={})).SMS="sms",i.SALES_BRIDGE="sales_bridge",i.EMAIL="email";class s extends o.Model{}s.init({email:{type:o.DataTypes.STRING},company_id:{allowNull:!1,type:o.DataTypes.UUID}},{sequelize:n.default,modelName:"EmailSenders",tableName:"email_senders"}),t.default=s},6584:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Models=void 0;const o=a(683),n=a(9760),i=a(6895),s=a(3886),l=a(3838),d=a(1002),r=a(4682),u=a(7851),c=a(6611),p=a(6897),m=a(5191),f=a(2360),y=a(4927),_=a(1036),g=a(362),S=a(262),T=a(4828),w=a(1199),h=a(6191);o.default.belongsTo(i.default,{as:"customer",foreignKey:"customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),o.default.belongsTo(p.default,{as:"users",foreignKey:"user_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),o.default.belongsTo(n.default,{as:"companys",foreignKey:"company_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),i.default.hasOne(s.default,{as:"customerAddress",foreignKey:"customer_id"}),i.default.hasOne(d.default,{as:"mealDeliverySubscription",foreignKey:"customer_id"}),i.default.hasOne(h.default,{as:"customerProduct",foreignKey:"customer_id"}),i.default.hasMany(r.default,{as:"fromMessage",foreignKey:"from_customer_id"}),i.default.hasMany(r.default,{as:"toMessage",foreignKey:"to_customer_id"}),i.default.hasMany(o.default,{as:"callLogs",foreignKey:"customer_id"}),i.default.hasMany(f.default,{as:"customers",foreignKey:"customer_id"}),n.default.belongsTo(l.default,{as:"industry",foreignKey:"industry_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),n.default.hasMany(p.default,{as:"users",foreignKey:"company_id"}),n.default.hasMany(T.default,{as:"emailSenders",foreignKey:"company_id"}),n.default.hasMany(w.default,{as:"customerTags",foreignKey:"company_id"}),s.default.belongsTo(i.default,{as:"customer",foreignKey:"customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),l.default.hasMany(n.default,{as:"companies",foreignKey:"industry_id"}),d.default.belongsTo(i.default,{as:"customer",foreignKey:"customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),r.default.belongsTo(i.default,{as:"from_customer",foreignKey:"from_customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),r.default.belongsTo(i.default,{as:"to_customer",foreignKey:"to_customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),r.default.belongsTo(p.default,{as:"users",foreignKey:"user_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),r.default.belongsTo(n.default,{as:"companys",foreignKey:"company_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),u.default.belongsTo(c.default,{as:"sales_template",foreignKey:"sales_template_id"}),c.default.hasMany(u.default,{as:"sales_recordings",foreignKey:"sales_template_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),p.default.belongsTo(n.default,{as:"companyInfo",foreignKey:"company_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),p.default.hasMany(r.default,{as:"messages",foreignKey:"user_id"}),p.default.hasMany(o.default,{as:"callLogs",foreignKey:"user_id"}),m.default.hasMany(f.default,{as:"audiencesCustomers",foreignKey:"audience_id"}),m.default.hasMany(y.default,{as:"campaigns",foreignKey:"audience_id"}),f.default.belongsTo(i.default,{as:"customer",foreignKey:"customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),f.default.belongsTo(m.default,{as:"audiences",foreignKey:"audience_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),y.default.belongsTo(m.default,{as:"audiences",foreignKey:"audience_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),y.default.hasMany(_.default,{as:"campaignsSteps",foreignKey:"campaign_id"}),_.default.hasMany(g.default,{as:"campaignsStepsTriggers",foreignKey:"campaign_step_id"}),_.default.belongsTo(y.default,{as:"campaign",foreignKey:"campaign_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),_.default.belongsTo(c.default,{as:"salesTemplate",foreignKey:"step_sales_template_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),g.default.belongsTo(_.default,{as:"campaignStep",foreignKey:"campaign_step_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),S.default.belongsTo(_.default,{as:"campaignStep",foreignKey:"campaign_step_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),S.default.belongsTo(m.default,{as:"audience",foreignKey:"audience_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),S.default.belongsTo(i.default,{as:"customer",foreignKey:"customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),h.default.belongsTo(i.default,{as:"customer",foreignKey:"customer_id",onUpdate:"CASCADE",onDelete:"SET NULL"}),t.Models={CallLogs:o.default,Customer:i.default,Company:n.default,CustomerAddress:s.default,Industry:l.default,MealDeliverySubscription:d.default,Message:r.default,SalesRecording:u.default,SalesTemplate:c.default,User:p.default,Audience:m.default,AudienceCustomer:f.default,Campaign:y.default,CampaignStep:_.default,CampaignStepTrigger:g.default,CampaignStepLog:S.default,EmailSender:T.default,CustomerTag:w.default,CustomerProduct:h.default}},3838:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},industry:{type:o.DataTypes.ENUM("Solar Company","Self Delivery Restaurant"),allowNull:!1}},{sequelize:n.default,modelName:"Industry",tableName:"industries"}),t.default=i},1002:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({order_code:{type:o.DataTypes.STRING,allowNull:!1},driver:{type:o.DataTypes.STRING,allowNull:!1},order_startdate:{type:o.DataTypes.DATE,allowNull:!1},order_enddate:{type:o.DataTypes.DATE,allowNull:!1},lunch_delivery:{type:o.DataTypes.BOOLEAN,allowNull:!1},dinner_delivery:{type:o.DataTypes.BOOLEAN,allowNull:!1},rice_addon:{type:o.DataTypes.BOOLEAN,allowNull:!1},order_quantity:{type:o.DataTypes.INTEGER,allowNull:!1},remarks:{type:o.DataTypes.TEXT,allowNull:!1},order_price:{type:o.DataTypes.FLOAT,allowNull:!1},delivery_time:{type:o.DataTypes.STRING,allowNull:!1},customer_id:{type:o.DataTypes.UUID,allowNull:!1}},{sequelize:n.default,modelName:"MealDeliverySubscription",tableName:"meal_delivery_subscription"}),t.default=i},4682:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({from:{type:o.DataTypes.STRING,allowNull:!1},to:{type:o.DataTypes.STRING,allowNull:!1},msg:{type:o.DataTypes.STRING,allowNull:!1},from_customer_id:{type:o.DataTypes.UUID,allowNull:!0},to_customer_id:{type:o.DataTypes.UUID,allowNull:!0},user_id:{type:o.DataTypes.UUID,allowNull:!0},company_id:{type:o.DataTypes.UUID,allowNull:!0}},{sequelize:n.default,modelName:"Message",tableName:"messages"}),t.default=i},7851:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141);class i extends o.Model{}i.init({id:{type:o.DataTypes.UUID,defaultValue:o.DataTypes.UUIDV4,primaryKey:!0},url:{allowNull:!1,type:o.DataTypes.STRING},sales_template_id:{type:o.DataTypes.UUID,allowNull:!0},is_selected:{allowNull:!1,type:o.DataTypes.BOOLEAN},is_deleted:{allowNull:!1,type:o.DataTypes.BOOLEAN}},{sequelize:n.default,modelName:"SalesRecordings",tableName:"sales_recordings"}),t.default=i},6611:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TemplateType=void 0;const o=a(496),n=a(9141);var i;(i=t.TemplateType||(t.TemplateType={})).SMS="sms",i.SALES_BRIDGE="sales_bridge",i.EMAIL="email";class s extends o.Model{}s.init({template_name:{allowNull:!1,type:o.DataTypes.STRING},template_type:{allowNull:!1,type:o.DataTypes.STRING},message:{allowNull:!1,type:o.DataTypes.STRING},email_subject:{type:o.DataTypes.STRING},company_id:{allowNull:!1,type:o.DataTypes.UUID},createdBy:{allowNull:!1,type:o.DataTypes.UUID},updatedBy:{allowNull:!1,type:o.DataTypes.UUID}},{sequelize:n.default,modelName:"SalesTemplates",tableName:"sales_templates"}),t.default=s},6897:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(496),n=a(9141),i=a(3553);class s extends o.Model{}s.init({name:{type:o.DataTypes.STRING,allowNull:!1,validate:{is:/^[A-Za-z ]+$/}},email:{type:o.DataTypes.STRING,allowNull:!1,unique:{name:"email",msg:"Please this email is already used, Provide another email!"},validate:{isEmail:{msg:"Please provide a valid email!"}}},twilio_country_code:{type:o.DataTypes.STRING,allowNull:!0},twilio_phone:{type:o.DataTypes.STRING,allowNull:!0},full_twilio_phone:{type:o.DataTypes.VIRTUAL,get(){const e=[];return this.twilio_country_code&&e.push(this.twilio_country_code),this.twilio_phone&&e.push(this.twilio_phone),e.join("")}},mobile_country_code:{type:o.DataTypes.STRING,allowNull:!0},mobile_phone:{type:o.DataTypes.STRING,allowNull:!0},full_mobile_phone:{type:o.DataTypes.VIRTUAL,get(){const e=[];return this.mobile_country_code&&e.push(this.mobile_country_code),this.mobile_phone&&e.push(this.mobile_phone),e.join("")}},password:{type:o.DataTypes.STRING,allowNull:!1},is_active:{type:o.DataTypes.BOOLEAN,defaultValue:!0},company_id:{type:o.DataTypes.UUID},roleType:{type:o.DataTypes.ENUM,values:i.ALL_ROLES_ARRAY,allowNull:!1,defaultValue:"none"}},{sequelize:n.default,modelName:"User",tableName:"users"}),t.default=s},1498:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(9344),i=a(6584),s=a(2720);t.default=(e,t,a)=>o(void 0,void 0,void 0,(function*(){try{let o;if(e.headers["x-auth-token"]&&(o=e.headers["x-auth-token"].toString()),!o)return a(new s.default("You are not logged In ! Please log in to get access.",401));n.verify(o,process.env.JWT_SECRET);const l=n.decode(o),d=yield i.Models.User.findOne({where:{id:l.payload.id},include:[{required:!1,model:i.Models.Company,as:"companyInfo"}]});return d?(e.user=d,a()):t.status(401).json({error:!0,message:"Unauthorized"})}catch(e){return t.status(401).json({error:!0,message:"Unauthorized"})}}))},5280:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(7372),s=o.Router();s.get("/list",n.default,i.default.getAudienceList),s.get("/:id",n.default,i.default.getAudienceDetail),s.post("/",n.default,i.default.addAudienceList),t.default=s},4559:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(198),s=o.Router();s.post("/",n.default,i.default.addLogRoute),t.default=s},1058:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(7906),s=o.Router();s.get("/list",n.default,i.CampaignController.getCampaignsList),s.post("/",n.default,i.CampaignController.addCampaign),s.get("/cron/campaign-trigger",i.CampaignController.runCampaignTriggerCron),t.default=s},2219:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(8258),s=o.Router();s.get("/",n.default,i.default.getCompanyDetails),s.post("/sales-templates/recordings/upload",n.default,i.default.uploadAudioToS3),s.post("/sales-templates",n.default,i.default.addCompanySalesTemplates),s.get("/sales-templates/list",n.default,i.default.getCompanySalesTemplates),s.get("/sales-templates/:id",n.default,i.default.getCompanySalesTemplateDetails),s.put("/sales-templates/:id",n.default,i.default.updateCompanySalesTemplates),s.delete("/sales-templates/recordings/:id",n.default,i.default.deleteAudioRecording),s.put("/:company_id",n.default,i.default.updateCompanySettings),t.default=s},4858:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(7651),s=a(9331),l=o.Router();l.get("/list",n.default,i.CustomerController.listCustomers),l.get("/info/:id",n.default,i.CustomerController.getCustomerInformation),l.get("/chats/:id",n.default,i.CustomerController.getCustomersChats),l.put("/create",n.default,i.CustomerController.createCustomer),l.patch("/:id",n.default,i.CustomerController.updateCustomerInformation),l.delete("/remove",n.default,i.CustomerController.deleteCustomersSubscription),l.post("/upload",n.default,s.uploadFiles.single("file"),i.CustomerController.uploadCSV),t.default=l},8470:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(6361),s=o.Router();s.get("/list",n.default,i.default.listIndustries),t.default=s},930:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(8351),s=o.Router();s.post("/",n.default,i.default.sendSMS),s.get("/",n.default,i.default.getAllmessages),s.post("/receive/:id",i.default.receiveSMS),s.post("/voice",i.default.voiceResponse),s.post("/token/generate",n.default,i.default.generateToken),t.default=s},393:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(446),s=o.Router();s.get("/list",n.default,i.TagsController.getTagsList),s.post("/",n.default,i.TagsController.addTag),s.put("/:id",n.default,i.TagsController.editTag),t.default=s},5566:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(6860),n=a(1498),i=a(4868),s=a(5587),l=o.Router();l.post("/signup",i.default.signup),l.post("/login",i.default.login),l.post("/",n.default,s.default.addUser),l.get("/list",n.default,s.default.getAllUsers),l.put("/:id",n.default,s.default.updateUser),t.default=l},2720:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class a extends Error{constructor(e,t){super(e),this.statusCode=t,this.status=`${t}`.startsWith("4")?"fail":"error",this.isOperational=!0,Error.captureStackTrace(this,this.constructor)}}t.default=a},9562:function(e,t,a){var o=this&&this.__awaiter||function(e,t,a,o){return new(a||(a=Promise))((function(n,i){function s(e){try{d(o.next(e))}catch(e){i(e)}}function l(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,l)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=a(9336),i=a(6517),s=a(1738),l=a(2776),d=a(3555),r=a(847),u=a(3645);n.config.update({secretAccessKey:process.env.AWS_ACCESS_KEY_SECRET,accessKeyId:process.env.AWS_ACCESS_KEY_ID,region:process.env.AWS_DEFAULT_REGION});const c=s({storage:l({s3:new n.S3,bucket:process.env.AWS_S3_RECORDINGS_BUCKET,key:(e,t,a)=>{a(null,`${t.originalname}.mp3`)},acl:"public-read",contentType:l.AUTO_CONTENT_TYPE}),limits:{fileSize:1048576},fileFilter:(e,t,a)=>{if(/audio/.test(t.mimetype))return a(null,!0);a("Error: Allowed audio only of extensions mp3 !")}}).array("audioFiles",5);t.default={aws:n,s3:new n.S3,S3Utils:{uploadAudioFiles:c},emailUtils:{sendEmail:e=>o(void 0,void 0,void 0,(function*(){return(new n.SES).sendEmail(e).promise().then((e=>(console.log(e),Promise.resolve()))).catch((e=>(console.log(e),Promise.reject(e))))})),sendEmailForCampaign:e=>o(void 0,void 0,void 0,(function*(){const t=new n.SES;return Promise.all(e.map((e=>t.sendEmail(e).promise().then((e=>e)).catch((e=>e)))))})),getParamsForCampaign:(e,t,a,o)=>i.map(e,(e=>{const n=(0,d.updateTagsToCustomerValue)(t.message,e.customer),i=(0,d.updateTagsToCustomerValue)(t.email_subject,e.customer);return{Source:a,Destination:{ToAddresses:[e.customer.email]},Message:{Body:{Html:{Charset:"UTF-8",Data:(0,r.getBasicEmailContent)({body:n,unsubscribeLink:`${u.Config.backendURL}/email/unsubsribe?co=${(0,d.encodeBase64)(o)}&cu=${(0,d.encodeBase64)(e.customer.id)}`})}},Subject:{Charset:"UTF-8",Data:i}}}})),createIdentity:e=>o(void 0,void 0,void 0,(function*(){const e=new n.SES,t=yield e.getIdentityVerificationAttributes({Identities:["digitalmarketingworld.com.au"]}).promise();console.log(t)}))}}},8268:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=e=>(t,a,o)=>{e(t,a,o).catch(o)}},3555:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isUUID=t.decodeBase64=t.encodeBase64=t.updateTagsToCustomerValue=t.isTemplateTypeEmail=t.isValidTemplateType=t.isContentTypeSalesBridge=t.isCampaignTypeSMS=t.isCampaignTypeEmail=t.isCampaignTypeCall=t.getRoundTimeCeil=t.getNearestRoundedNumber=t.Role=t.parseIntNumber=t.isAValid10DigitPhoneNumber=t.isAValidPhoneNumber=t.getQueryBuilder=t.getTrim=t.getTrimAndLowerCase=t.getPagination=t.getSQLOperator=void 0;const o=a(496),n=a(6517),i=a(2245),s=a(3553),l=a(1036),d=a(6611);t.getSQLOperator=(e,t)=>{const a={};return e===s.QUERY_OPERATORS.CONTAINS?a[o.Op.iLike]=`%${t}%`:e===s.QUERY_OPERATORS.EQUALS?a[o.Op.eq]=t:e===s.QUERY_OPERATORS.STARTS_WITH?a[o.Op.startsWith]=t:e===s.QUERY_OPERATORS.ENDS_WITH?a[o.Op.endsWith]=t:e===s.QUERY_OPERATORS.IS_EMPTY?a[o.Op.or]={[o.Op.eq]:null,[o.Op.eq]:""}:e===s.QUERY_OPERATORS.IS_NOT_EMPTY&&(a[o.Op.or]={[o.Op.ne]:null,[o.Op.ne]:""}),a},t.getPagination=(e,t)=>{const a=+t;return{limit:a,offset:e?e*a:0}},t.getTrimAndLowerCase=e=>e&&e.trim().toLowerCase(),t.getTrim=e=>e&&e.trim(),t.getQueryBuilder=e=>{let a={};try{a=JSON.parse(e)}catch(t){a=e}let s={};const l=n.get(a,"items",[]);if(l.length){const e=[];n.forEach(l,(a=>{const o=a;o.value&&(-1!==o.columnField.indexOf(".")&&(o.columnField=`$${o.columnField}$`),-1!==o.columnField.indexOf("createdAt")?i(o.value).isValid()&&e.push({[o.columnField]:(0,t.getSQLOperator)(o.operatorValue,i(o.value).format("MM-DD-YYYY"))}):e.push({[o.columnField]:(0,t.getSQLOperator)(o.operatorValue,o.value)}))})),e.length&&(s="and"===a.linkOperator?{[o.Op.and]:e}:{[o.Op.or]:e})}else n.keys(a).length&&n.forEach(a,((e,t)=>{e&&(s[t]=e)}));return s},t.isAValidPhoneNumber=e=>/^[\d\\+\-\\(\\) ]+$/.test(e),t.isAValid10DigitPhoneNumber=e=>!(e&&!/[1-9]{1}[0-9]{9}/.test(e)),t.parseIntNumber=e=>parseInt(e,10),t.Role={isSuperUser:e=>e.roleType===s.ALL_ROLES.SUPERUSER,isSuperUserOrManagement:e=>e.roleType===s.ALL_ROLES.SUPERUSER||e.roleType===s.ALL_ROLES.MANAGEMENT,hasCompany:e=>!n.isEmpty(e.company_id)},t.getNearestRoundedNumber=e=>10*Math.ceil(e/10),t.getRoundTimeCeil=(e,t)=>i(Math.ceil(+e/+t)*+t),t.isCampaignTypeCall=e=>e===l.StepCampaignType.CALL,t.isCampaignTypeEmail=e=>e===l.StepCampaignType.EMAIL,t.isCampaignTypeSMS=e=>e===l.StepCampaignType.SMS,t.isContentTypeSalesBridge=e=>e===l.StepCampaignContentType.SALES_BRIDGE,t.isValidTemplateType=e=>n.includes(n.values(d.TemplateType),e),t.isTemplateTypeEmail=e=>e===s.SALES_TEMPLATES_TYPE.email,t.updateTagsToCustomerValue=(e,t)=>{let a=e;const o=e=>n.get(t,e,""),i=[{key:"customer_name",value:o("name")},{key:"address",value:o("customerAddress.address")},{key:"zip",value:o("customerAddress.zipCode")}];return n.forEach(i,(e=>{a=a.replace(`{{${e.key}}}`,e.value)})),a},t.encodeBase64=e=>Buffer.from(e).toString("base64"),t.decodeBase64=e=>Buffer.from(e,"base64").toString("ascii"),t.isUUID=e=>/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(e)},3645:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Config=void 0,a(5142).config({path:".env"}),t.Config={port:process.env.PORT||4e3,backendURL:process.env.API_URL}},3553:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OPT_OUT_KEYWORDS=t.TYPE_ALL=t.CONTACT_CREATE_PROMISE_BATCH_RECORDS=t.MAX_CUSTOMER_CSV_ALLOWED=t.MINIMUM_DELAY_IN_PROCESSING_CUSTOMERS_JOBS_IN_SECONDS=t.MINIMUM_DELAY_IN_IMMEDIATE_JOBS_IN_SECONDS=t.MINIMUM_DELAY_IN_JOBS_IN_SECONDS=t.MINIMUM_DELAY_TIME_FOR_MINUTES=t.CAMPAIGN_STATUS_ARRAY=t.CAMPAIGN_STATUS=t.AUDIENCE_STATUS_ARRAY=t.AUDIENCE_STATUS=t.AUDIENCE_CREATION_STATUS_ARRAY=t.AUDIENCE_CREATION_STATUS=t.ALL_ROLES_ARRAY=t.ALL_ROLES=t.SALES_TEMPLATES_TYPE=t.QUERY_OPERATORS=void 0;const o=a(6517);t.QUERY_OPERATORS={CONTAINS:"contains",EQUALS:"equals",STARTS_WITH:"startsWith",ENDS_WITH:"endsWith",IS_EMPTY:"isEmpty",IS_NOT_EMPTY:"isNotEmpty"},t.SALES_TEMPLATES_TYPE={SALES_BRIDGE:"sales_bridge",SMS:"sms",email:"email"},t.ALL_ROLES={NONE:"none",MANAGEMENT:"management",SUPERUSER:"superuser",STORE_STAFF:"store_staff",DRIVER:"driver",CHEF:"chef",SALES_REP:"sales_rep"},t.ALL_ROLES_ARRAY=o.values(t.ALL_ROLES),t.AUDIENCE_CREATION_STATUS={DEFAULT:"default",INPROGRESS:"inprogress",CREATED:"created",DELETED:"deleted"},t.AUDIENCE_CREATION_STATUS_ARRAY=o.values(t.AUDIENCE_CREATION_STATUS),t.AUDIENCE_STATUS={DEFAULT:"default",ACTIVE:"active",PAUSED:"paused"},t.AUDIENCE_STATUS_ARRAY=o.values(t.AUDIENCE_STATUS),t.CAMPAIGN_STATUS={DEFAULT:"default",ACTIVE:"active",PAUSED:"paused"},t.CAMPAIGN_STATUS_ARRAY=o.values(t.CAMPAIGN_STATUS),t.MINIMUM_DELAY_TIME_FOR_MINUTES=10,t.MINIMUM_DELAY_IN_JOBS_IN_SECONDS=10,t.MINIMUM_DELAY_IN_IMMEDIATE_JOBS_IN_SECONDS=5e3,t.MINIMUM_DELAY_IN_PROCESSING_CUSTOMERS_JOBS_IN_SECONDS=5e3,t.MAX_CUSTOMER_CSV_ALLOWED=2e4,t.CONTACT_CREATE_PROMISE_BATCH_RECORDS=200,t.TYPE_ALL="all",t.OPT_OUT_KEYWORDS=["opt-out","optout"]},847:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getBasicEmailContent=void 0,t.getBasicEmailContent=e=>`\n  <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\n  <html xmlns="http://www.w3.org/1999/xhtml">\n  <head>\n  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>\n  <style type="text/css">\n  body {margin: 0; padding: 0; min-width: 100%!important;}\n  img {height: auto;}\n  .content {width: 100%; max-width: 600px;}\n  .header {padding: 40px 30px 20px 30px;}\n  .innerpadding {padding: 30px 30px 30px 30px;}\n  .borderbottom {border-bottom: 1px solid #f2eeed;}\n  .subhead {font-size: 15px; color: #ffffff; font-family: sans-serif; letter-spacing: 10px;}\n  .h1, .h2, .bodycopy {color: #153643; font-family: sans-serif;}\n  .h1 {font-size: 33px; line-height: 38px; font-weight: bold;}\n  .h2 {padding: 0 0 15px 0; font-size: 24px; line-height: 28px; font-weight: bold;}\n  .bodycopy {font-size: 16px; line-height: 22px;}\n  .button {text-align: center; font-size: 18px; font-family: sans-serif; font-weight: bold; padding: 0 30px 0 30px;}\n  .button a {color: #ffffff; text-decoration: none;}\n  .footer {padding: 20px 30px 15px 30px;}\n  .footercopy {font-family: sans-serif; font-size: 14px; color: #ffffff;}\n  .footercopy a {color: #ffffff; text-decoration: underline;}\n  @media only screen and (max-width: 550px), screen and (max-device-width: 550px) {\n  body[yahoo] .hide {display: none!important;}\n  body[yahoo] .buttonwrapper {background-color: transparent!important;}\n  body[yahoo] .button {padding: 0px!important;}\n  body[yahoo] .button a {background-color: #effb41; padding: 15px 15px 13px!important;}\n  body[yahoo] .unsubscribe {display: block; margin-top: 20px; padding: 10px 50px; background: #2f3942; border-radius: 5px; text-decoration: none!important; font-weight: bold;}\n  }\n  /*@media only screen and (min-device-width: 601px) {\n  .content {width: 600px !important;}\n  .col425 {width: 425px!important;}\n  .col380 {width: 380px!important;}\n  }*/\n  </style>\n  </head>\n  <body yahoo bgcolor="#ffffff">\n  <table width="100%" bgcolor="#ffffff" border="0" cellpadding="0" cellspacing="0">\n  <tr>\n    <td>\n      \x3c!--[if (gte mso 9)|(IE)]>\n        <table width="600" align="center" cellpadding="0" cellspacing="0" border="0">\n        <tr>\n        <td>\n        <![endif]--\x3e\n      <table bgcolor="#ffffff" class="content" align="center" cellpadding="0" cellspacing="0" border="0">\n\n      <tr>\n        <td class="innerpadding bodycopy">\n           ${e.body}\n        </td>\n      </tr>\n      <tr>\n        <td class="footer" bgcolor="#44525f">\n          <table width="100%" border="0" cellspacing="0" cellpadding="0">\n          <tr>\n            <td align="center" class="footercopy">\n              <a href="${e.unsubscribeLink}" class="unsubscribe"><font color="#ffffff">Unsubscribe</font></a>\n              <span class="hide">from these emails</span>\n            </td>\n          </tr>\n          </table>\n        </td>\n      </tr>\n      </table>\n      \x3c!--[if (gte mso 9)|(IE)]>\n  </td>\n  </tr>\n  </table>\n  <![endif]--\x3e\n    </td>\n  </tr>\n  </table>\n  </body>\n  `},9331:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.uploadFiles=void 0;const o=a(1738),n=a(1017),i=a(2720),s=o.diskStorage({destination:function(e,t,a){a(null,"tmp/uploads")},filename:function(e,t,a){const o=n.extname(t.originalname).split(".")[1];if(/csv/.test(t.mimetype))return a(null,`${(new Date).getTime()}.${o}`);a(new i.default("Error: Allowed csv files only!",400))}});t.uploadFiles=o({storage:s})},6645:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0});const o=a(7773);o.addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const n=o.format.combine(o.format.timestamp({format:"YYYY-MM-DD HH:mm:ss:ms"}),o.format.colorize({all:!0}),o.format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),i=o.createLogger({transports:[new o.transports.Console({format:n})]});t.default=i},8216:(e,t,a)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TwilioHelper=void 0;const o=a(6517),n=a(7202),i=a(3555);t.TwilioHelper=class{constructor(e,t){this.client=new n.Twilio(e,t)}makeVoiceCallOneByOne(e,t,a){return Promise.all(e.map((e=>{let i=new n.twiml.VoiceResponse;o.forEach(t,(e=>{i.play(e.url)}));const s={twiml:i.toString(),to:e.customer.full_mobile,from:a};return this.client.calls.create(s).then((e=>e)).catch((e=>e))})))}makeSMSOneByOne(e,t,a){return Promise.all(e.map((e=>{const o=(0,i.updateTagsToCustomerValue)(t,e.customer),n={to:e.customer.full_mobile,messagingServiceSid:a,body:o};return this.client.messages.create(n).then((e=>e)).catch((e=>e))})))}}},9336:e=>{e.exports=require("aws-sdk")},8432:e=>{e.exports=require("bcryptjs")},5086:e=>{e.exports=require("bull-board")},2471:e=>{e.exports=require("bull-board/bullMQAdapter")},7807:e=>{e.exports=require("bullmq")},7455:e=>{e.exports=require("compression")},3582:e=>{e.exports=require("cors")},8160:e=>{e.exports=require("csvtojson")},5142:e=>{e.exports=require("dotenv")},6860:e=>{e.exports=require("express")},9344:e=>{e.exports=require("jsonwebtoken")},6517:e=>{e.exports=require("lodash")},2245:e=>{e.exports=require("moment")},1738:e=>{e.exports=require("multer")},2776:e=>{e.exports=require("multer-s3")},496:e=>{e.exports=require("sequelize")},7202:e=>{e.exports=require("twilio")},5828:e=>{e.exports=require("uuid")},7773:e=>{e.exports=require("winston")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},3837:e=>{e.exports=require("util")}},t={};!function a(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,a),i.exports}(4137)})();
//# sourceMappingURL=campaign-call.cron.js.map